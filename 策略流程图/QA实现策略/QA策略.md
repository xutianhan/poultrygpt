Dify Cloud 的 **“父子段分隔符”实现简易 QA 对**，本质上是一种**基于段落结构的语义分块和关联召回机制**。

---

### 一、原理概述

Dify 的知识库引擎是基于文本分段进行向量化和检索的，它通过\*\*父段（Parent）+ 子段（Child）\*\*的结构来构建“语义单元”：

* **父段（Parent segment）**：被用作索引的主文本，系统会**对父段进行向量化并存入向量数据库**（如内置 FAISS）
* **子段（Child segment）**：作为父段的扩展信息，一起存储，但**不参与向量召回**，仅在父段被召回时随之返回

> 简单理解为：“**用父段来召回，用子段来补充内容**”。

---

### 二、在 QA 场景下的映射机制

可以将：

* **父段** 视为 “问题（Question）”
* **子段** 视为 “回答（Answer）”

这样就实现了一个基础的问答匹配逻辑：

| 段落类型 | 内容例子             | 系统行为                   |
| ---- | ---------------- | ---------------------- |
| 父段   | 什么是高血压？          | 进行向量化，作为检索主句           |
| 子段   | 高血压是指动脉血压持续升高... | 不参与向量检索，只在对应父段被召回时附带展示 |

---

### 三、召回流程示意（核心逻辑）

1. **用户输入 Query**：比如：“什么是高血压？？”
2. 系统会对这个 Query 做 embedding（向量化）
3. 拿这个向量去知识库中找最相似的“父段向量”（比如：“高血压是什么”）
4. 一旦召回这个父段，它所绑定的“子段”（即回答）也会一起返回
5. 返回结果组合给大语言模型进行重写或直接呈现

---

### 四、为什么子段不参与向量召回？

* 避免噪音：如果让 Answer 也做 embedding，就会导致“回答内容被误召回”，比如你问“高血压的标准”，可能会召回“糖尿病的标准”中的 answer 字段，因为文字相似。
* 提高召回精准度：确保用户输入的 query 是与“问题”本身对齐，而不是回答中的关键词干扰。

---

### 五、常见误区

| 误解            | 正确解释                 |
| ------------- | -------------------- |
| 子段也会被匹配       | ❌ 子段仅作展示，**不参与向量检索** |
| 可以多个父段匹配一个子段  | ❌ 每个子段只属于一个父段        |
| 可以用字段配置指定 Q/A | ❌ 仅靠分隔符，不能设字段名       |

---

### ✅ 适用场景

* 适合小规模、格式化好的 QA 数据
* 适合不需要复杂字段映射的基础问答库

---

### 📘 示例格式：

上传的原始文本：

```
[question]什么是高血压？
[answer]高血压是指动脉血压持续升高，是一种常见的慢性疾病。

[question]高血压的主要症状有哪些？
[answer]主要包括头痛、头晕、心悸、视力模糊等。
```

上传设置中配置：

* 父段分隔符：`[question]`
* 子段分隔符：`[answer]`

系统最终构建如下结构：

| 父段（向量化）      | 子段（绑定但不向量化）               |
| ------------ | ------------------------- |
| 什么是高血压？      | 高血压是指动脉血压持续升高，是一种常见的慢性疾病。 |
| 高血压的主要症状有哪些？ | 主要包括头痛、头晕、心悸、视力模糊等。       |


